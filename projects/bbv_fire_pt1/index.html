<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NSK99TZ0"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-01NSK99TZ0");</script> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Experimenting with the BeagleV-Fire | Aven Arlington</title> <meta name="author" content="Aven Arlington"> <meta name="description" content="My experience getting started with a BeagleV-Fire SoC (RiscV + FPGA) SBC."> <meta name="keywords" content="Rust programming language, Rust tutorials, Rust graphics programming, Rust utilities, Rust projects, Rust examples, Rust game development tutorials, Rust embedded systems programming guide, Graphics programming using Rust language, Embedded development with Rust, IoT programming in Rust, Video game design in Rust, IoT projects with Rust programming, Circuit design, portfolio-website, tutorial, "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://aven-arlington.github.io/projects/bbv_fire_pt1/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Aven </span>Arlington</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">GitHub Repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Experimenting with the BeagleV-Fire</h1> <p class="post-description">My experience getting started with a BeagleV-Fire SoC (RiscV + FPGA) SBC.</p></header> <article> <h2 id="topics-covered">Topics Covered</h2> <ul> <li>My experience getting started with the BeagleV-Fire SoC development board.</li> </ul> <h2 id="background">Background</h2> <p>I have been reading a lot about RISC-V over the last year and have been wanting to experiment with some of the many popular development boards. When I came across an article about the PolarFire System on Chip (SoC) design from Microchip I was instantly intrigued about the possibilities of combining the RISC-V with on chip FPGA resources. So I ordered a new BeagleV-Fire development board to tinker with it and try out some cross-platform development.</p> <h2 id="my-journey">My Journey</h2> <h3 id="boot-up-and-go">Boot-up and Go</h3> <p>I started this experiment on a fresh installation of Ubuntu 22.04 which I then configured with my development preferences and utilities.</p> <p>The BeagleV-Fire comes with a version of Ubuntu installed on the eMMC out of the box. It was able to connect it to the LAN, start the board up, and ssh into it in a few minutes with no problems. It even came with an older version of Rust pre-installed which was a nice surprise. I ran into a minor issue when trying to update Rust to the newest version because while <code class="language-plaintext highlighter-rouge">cargo</code> and <code class="language-plaintext highlighter-rouge">rustc</code> are installed, <code class="language-plaintext highlighter-rouge">rustup</code> is not. The eMMC is only 16 Gb so I can understand not wanting to include the package manager with the core functionalities. I went to update the Rust components but received an error because <code class="language-plaintext highlighter-rouge">rustup</code> detected an existing installation. I removed <code class="language-plaintext highlighter-rouge">rustc</code> with the package manager and the normal rustup installation proceeded without issue.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go"> sudo apt remove rustc
</span></code></pre></div></div> <p>With the latest version of Rust installed, I could created a new cargo package with a “Hello World” message and everything worked fine.</p> <h3 id="imaging-the-soc">Imaging the SoC</h3> <p>The MPFS250T (PolarFire SoC) is a little different than other devices I have worked with in that the eMMC and microSD port are multiplexed in the MPFS250T so that only one or the other can be accessed by the chip directly. The BeagleV-Fire designers chose the eMMC route for booting and OS storage and exposed the microSD port through the OS via a SPI-MMC device in the device tree. For bulk data storage I inserted a formatted microSD card and searched for it with a <code class="language-plaintext highlighter-rouge">lsblk</code> command where it showed up as <code class="language-plaintext highlighter-rouge">mmcblk1</code>.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">beagle@beaglev:~$</span><span class="w"> </span>lsblk
<span class="go">NAME         MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
mmcblk0      179:0    0  14.6G  0 disk
├─mmcblk0p1  179:1    0   684K  0 part
├─mmcblk0p2  179:2    0    60M  0 part /boot/firmware
└─mmcblk0p3  179:3    0  14.5G  0 part /
mmcblk1      179:8    0 119.1G  0 disk
└─mmcblk1p1  179:9    0 119.1G  0 part
mmcblk0boot0 179:16   0     4M  1 disk
mmcblk0boot1 179:24   0     4M  1 disk
</span></code></pre></div></div> <p>Unfortunately, after trying everything could google could throw at me, I couldn’t get the drive to mount properly for use as additional storage space. The discord support forum had several posts that the support for the sd card wasn’t ready yet so maybe this will be working soon.</p> <p>To access the eMMC for flashing a new OS image, the multiplexer needs to be switched to expose the eMMC storage through the USB-C port. This is done with a serial RS-232 connection on the debug header. I setup a Raspberry Pi Debug probe and hooked Rx, Tx, and Gnd up according to the <a href="https://docs.beagle.cc/latest/boards/beaglev/fire/demos-and-tutorials/flashing-board.html#beaglev-fire-flashing-board" rel="external nofollow noopener" target="_blank">instructions</a> and opened a serial terminal with <a href="https://github.com/tio/tio" rel="external nofollow noopener" target="_blank">Tio</a>. Rebooting produces a progress bar and right as it completes there is a prompt to hit any key alphanumeric key (space doesn’t work). When I timed it right, the HSS command prompt showed up and I could switch the eMMC to the USB-C. My Ubuntu installation detected it immediately and mounted it without issues. Flashing was straightforward with the following highlights:</p> <ul> <li>The most recent images can be found in this <a href="https://www.beagleboard.org/distros" rel="external nofollow noopener" target="_blank">repository</a>.</li> <li>The documentation implied that would find a <code class="language-plaintext highlighter-rouge">*.img</code> file but I didn’t find one in the download.</li> <li>After poking around a bit I figured out that Balena etcher would accept the <code class="language-plaintext highlighter-rouge">sdcard.img.xz</code> file so that is what I used.</li> <li>After flashing, the first boot took a bit longer and appeared to hang after a verification step of some kind. This might or might not be intentional. Resetting the board proceeded normally on the second boot.</li> </ul> <h3 id="software-installation">Software Installation</h3> <p>The PolarFire SoC requires Microchip’s Libero Design Suite. When installing the suite there are a few gotchas that can derail the process and make it much more painful that necessary. I recommend following <a href="https://docs.beagle.cc/latest/boards/beaglev/fire/demos-and-tutorials/mchp-fpga-tools-installation-guide.html#beaglev-fire-mchp-fpga-tools-installation-guide" rel="external nofollow noopener" target="_blank">the instructions here</a> as they mostly cover those gotchas. I will highlight what I learned from my experience.</p> <ul> <li>Install the Linux Standard Base (lsb) package. This is required for the licensing daemons or they output a misleading error that will lead down a rabbit hole.</li> <li>Create a directory to contain all the Microchip software. Something like <code class="language-plaintext highlighter-rouge">~/Microchip</code> will work well and will prevent manual modification of helpful script files.</li> <li>Do not install the Microchip software in the default location.</li> <li>Do install Libero, SoftConsole, Licenses, etc in your <code class="language-plaintext highlighter-rouge">~/Microchip</code> directory.</li> <li>Read the post-install instructions after installing SoftConsole. If that step is missed, the documentation can be found after the install at “~/Microchip/SoftConsole-v2022.2-RISC-V-747/documentation/softconsole/using_softconsole/post_installationhtml”</li> <li>Take advantage of the helpful script provided in the <a href="https://openbeagle.org/beaglev-fire/Microchip-FPGA-Tools-Setup" rel="external nofollow noopener" target="_blank">Microchip FPGA Tools Setup</a> repo. Make sure to update it with your installation specific path details. It will then start the licensing daemons for you and configure the correct environment variables.</li> </ul> <h3 id="fpga-programming-defaults">FPGA Programming (Defaults)</h3> <p>The documentation advises against trying to create FPGA logic from a blank Libero project. Instead the <a href="https://openbeagle.org/beaglev-fire/gateware" rel="external nofollow noopener" target="_blank">Gateware repository</a> provides helpful scripts that create a pre-configured Libero project for you that can be customized to your needs.</p> <p>Before I create custom FPGA logic, it makes sense to build and test a default bit stream to learn the process. Even though I probably don’t need local copies of <a href="https://openbeagle.org/beaglev-fire" rel="external nofollow noopener" target="_blank">these repositories</a>, having them does make searching for documentation and figuring out how things go together much easier. I start by cloning them into a top level folder and end up with a tree like this:</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">./bbv_fire/
├── beaglev-fire
├── beaglev-fire-ubuntu
├── gateware
├── gateware-snapshots
├── hart-software-services
└── microchip-fpga-tools-setup
</span></code></pre></div></div> <p>Next, I installed the Python 3 dependencies and tried to run the default build script.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">python3 build-bitstream.py ./build-options/default.yaml
</span></code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">build-bitstream.py</code> script worked well and provided useful output and guidance for problems. In my case, the <code class="language-plaintext highlighter-rouge">setup-microchip-tools.sh</code> script that I modified to point to my installation directory contained an invalid path so I had to double-check my <code class="language-plaintext highlighter-rouge">PATH</code> exports and compare them with the actual install paths. Once I had correct <code class="language-plaintext highlighter-rouge">PATH</code> variables, the build completed without any issues.</p> <p>Performing a git status on the repo shows that the build process has generated a few new folders. The <code class="language-plaintext highlighter-rouge">gateware/work/</code> contains a pre-compiled HSS bootloader binary in addition to the script generated Libero project that executed the FPGA synthesis, routing, etc to generate the bitstream. The <code class="language-plaintext highlighter-rouge">gateware/bitstream</code> folder contains the actual bitstream output I am most interested in.</p> <p>Now the <a href="https://docs.beagleboard.org/latest/boards/beaglev/fire/demos-and-tutorials/gateware/gateware-full-flow.html" rel="external nofollow noopener" target="_blank">documentation</a> didn’t provide a large amount of detail as to how to actually load the FPGA image but it does point to a script to execute on the BeagleV device at <code class="language-plaintext highlighter-rouge">/usr/share/beagleboard/gateware</code>. I opened up that script and determined that it does the following things:</p> <ul> <li>Checks for sudo privileges.</li> <li>Checks the first argument to see if it is a valid directory.</li> <li>Checks for the presence of both <code class="language-plaintext highlighter-rouge">LinuxProgramming/mpfs_bitstream.spi</code> and <code class="language-plaintext highlighter-rouge">LinuxProgramming/mpfs_dtbo.spi</code>.</li> <li>If both checks succeed, calls the <code class="language-plaintext highlighter-rouge">update-gateware.sh</code> script in <code class="language-plaintext highlighter-rouge">/usr/share/microchip/gateware</code> to do the heavy lifting.</li> </ul> <p>So I used <code class="language-plaintext highlighter-rouge">scp</code> to copy my generated <code class="language-plaintext highlighter-rouge">LinuxProgramming</code> directory over to the home directory on the BeagleV device and ran the script:</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">beagle@BeagleV:/usr/share/beagleboard/gateware$</span><span class="w"> </span><span class="nb">sudo</span> ./change-gateware.sh /home/beagle/
</code></pre></div></div> <p>The BeagleV device took a few minutes to finish flashing and rebooting and everything worked fine. It did feel strange to me to provide the parent of the <code class="language-plaintext highlighter-rouge">LinuxProgramming</code> folder to the script so I may modify that so that it uses that folder directly.</p> <p>Checking the serial console output from the reboot shows that the <code class="language-plaintext highlighter-rouge">Design Name</code> is the same as it was before the flashing process. This might be expected since I built the default configuration so I will check this again in the next step when I build custom FPGA logic.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[5.779029] Design Info:
    Design Name: CI_DEFAULT_FD28A2CA1789CDC1137
    Design Version: 02.00.2
</span></code></pre></div></div> <h3 id="fpga-programming-custom">FPGA Programming (Custom)</h3> <p>Now that I know more about how the gateware creation process works I want to “unwind the stack” a bit and see how I can customize my FPGA. I will note that the documentation, while very helpful where it exists, is often missing. Be prepared to dive into the scripts to see what they do. The <code class="language-plaintext highlighter-rouge">build-bitstream.py</code> is definitely worth a read and is almost better than a readme file.</p> <p>The <code class="language-plaintext highlighter-rouge">build-bitstream.py</code> needs a <code class="language-plaintext highlighter-rouge">yaml</code> configuration file so I did a quick search and compared between the <code class="language-plaintext highlighter-rouge">default.yaml</code> and the others to see how they work. They all had the <code class="language-plaintext highlighter-rouge">HSS</code> object in common and I don’t want to modify that so it is safe to assume I can copy that section for my custom build. The also define a <code class="language-plaintext highlighter-rouge">gateware</code> datatype which is what I want to customize so I again compared them all. They shared a <code class="language-plaintext highlighter-rouge">type: sources</code> and listed various <code class="language-plaintext highlighter-rouge">build-args</code>. Looking through the <code class="language-plaintext highlighter-rouge">build-bitstream.py</code> helped me to understand this better and it turns out that each top level object is a key and each one is parsed to check it’s <code class="language-plaintext highlighter-rouge">type</code>. Depending on the <code class="language-plaintext highlighter-rouge">key.type</code> different actions are performed. For <code class="language-plaintext highlighter-rouge">type: git</code>, the repository is cloned into the <code class="language-plaintext highlighter-rouge">gateware/sources/</code> folder and <code class="language-plaintext highlighter-rouge">*.zip</code> files are extracted there. If <code class="language-plaintext highlighter-rouge">type: sources</code> no action is taken and the directory is added to the list of sources.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">HSS</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">link</span><span class="pi">:</span> <span class="s">https://git.beagleboard.org/beaglev-fire/hart-software-services.git</span>
    <span class="na">branch</span><span class="pi">:</span> <span class="s">develop-beaglev-fire</span>
    <span class="na">board</span><span class="pi">:</span> <span class="s">bvf</span>
<span class="na">gateware</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sources</span>
    <span class="na">build-args</span><span class="pi">:</span> <span class="s2">"</span><span class="s">M2_OPTION:NONE</span><span class="nv"> </span><span class="s">CAPE_OPTION:VERILOG_TUTORIAL"</span>
    <span class="na">unique-design-version</span><span class="pi">:</span> <span class="s">9.0.2</span>
</code></pre></div></div> <p>Since no action is taken if <code class="language-plaintext highlighter-rouge">type: sources</code>, the <code class="language-plaintext highlighter-rouge">gateware/sources</code> folder seemed like a good place to start looking for more information. The <code class="language-plaintext highlighter-rouge">FPGA-Design</code> sub-folder does have additional documentation on how to create a FPGA Libero project from a tickle script. The <code class="language-plaintext highlighter-rouge">Readme.md</code> file provides an example command and documentation on the various options available. Running the command will trigger Libero to build a FPGA project through <code class="language-plaintext highlighter-rouge">*.tcl</code> scripts using the provided options for configuration.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">libero SCRIPT:BUILD_BVF_GATEWARE.tcl "SCRIPT_ARGS: ONLY_CREATE_DESIGN M2_OPTION:NONE CAPE_OPTION:NONE"
</span></code></pre></div></div> <p>Reading through the available <code class="language-plaintext highlighter-rouge">SCRIPT_ARGS</code> I notice that the <code class="language-plaintext highlighter-rouge">CAPE_OPTION</code> provides additional details on how to customize my FPGA:</p> <blockquote> <p>… Valid values are the directory names in ./script_support/components/CAPE. If you wish to create an alternate build option, add a new directory in ./script_support/components/CAPE using one of the existing ones as template. This is a good place to start if you want to play with FPGA digital logic.</p> </blockquote> <p>Perfect! Now I need to figure out which one to use as a template to start from. Again I do a quick search and find that there is a <code class="language-plaintext highlighter-rouge">Readme.md</code> file in most of the <code class="language-plaintext highlighter-rouge">FPGA_design/script_support/components/CAPE/*</code> sub-folders that contain pin mapping documentation. I can compare these file in vscode or use a <code class="language-plaintext highlighter-rouge">diff</code> command to see what changes are made from the default. I remembered noticing the <code class="language-plaintext highlighter-rouge">gateware/custom-fpga-design/my_custom_fpga_design.yaml</code> configuration file in a earlier step and one of the <code class="language-plaintext highlighter-rouge">build-args</code> was <code class="language-plaintext highlighter-rouge">VERILOG_TUTORIAL</code> which seemed to bea good starting point for custom logic. So I start to dig around a bit more and find that in <code class="language-plaintext highlighter-rouge">FPGA_design/script_support/components/CAPE/</code> there is both a <code class="language-plaintext highlighter-rouge">VERILOG_TUTORIAL</code> and <code class="language-plaintext highlighter-rouge">VERILOG_TEMPLATE</code> folder. Either of which should be viable for cloning and customizing. Unfortunately, I didn’t see a <code class="language-plaintext highlighter-rouge">Readme.md</code> file for either of these capes but they both have a <code class="language-plaintext highlighter-rouge">HDL</code> sub-folder that includes Verilog text files. It was pretty easy to view these in vscode to see and compare them the defaults.</p> <p>For experimentation I decided to start with a clone of the <code class="language-plaintext highlighter-rouge">VERILOG_TEMPLATE</code> folder and see if I could modify it as I would with custom logic so that it produces the same output as the <code class="language-plaintext highlighter-rouge">VERILOG_TUTORIAL</code>.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">cp</span> <span class="nt">-r</span> ./VERILOG_TEMPLATE ./CUSTOM_CAPE
</code></pre></div></div> <p>Once the template is copied, I open the new folder up in vscode and perform a search for <code class="language-plaintext highlighter-rouge">VERILOG_TEMPLATE</code> and replace it with my new name <code class="language-plaintext highlighter-rouge">CUSTOM_CAPE</code>. In this case, it only affected the the <code class="language-plaintext highlighter-rouge">ADD_CAPE.tcl</code> script. Next I needed to create the Libero project so I can write, simulate, and synthesize my custom design.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">aven:~/bbv_fire/gateware/sources/FPGA-design$</span><span class="w"> </span>libero SCRIPT:BUILD_BVF_GATEWARE.tcl <span class="s2">"SCRIPT_ARGS: ONLY_CREATE_DESIGN PROJECT_LOCATION:</span><span class="se">\"</span><span class="s2">~/repos/riscv-fpga/my_custom_cape</span><span class="se">\"</span><span class="s2"> TOP_LEVEL_NAME:</span><span class="se">\"</span><span class="s2">my_custom_cape</span><span class="se">\"</span><span class="s2"> M2_OPTION:NONE CAPE_OPTION:CUSTOM_CAPE"</span>
</code></pre></div></div> <p>Once the script is complete, I can open Libero and then open the newly created project in the folder I specified in the script. From here, I created a new HDL source file with the <code class="language-plaintext highlighter-rouge">Create HDL</code> wizard and named it <code class="language-plaintext highlighter-rouge">my_logic.v</code>. I am only interested in “simulating” the actual FPGA logic design process for now so instead of creating HDL from scratch, I copied the logic from <code class="language-plaintext highlighter-rouge">VERILOG_TUTORIAL/HDL/blinky.v</code> and updated the <code class="language-plaintext highlighter-rouge">CAPE.v</code> file to connect the wires. I double-checked the work with a <code class="language-plaintext highlighter-rouge">diff</code> command on my HDL folder and the tutorial to make sure I updated everything right. Then I executed the design flow and went through synthesis, place &amp; route, etc. without any issues.</p> <p>There were several hundred warnings generated about “User defined pragma syn_black_box” declarations but from what I could tell, were possibly due to weird formatting of the code generated <code class="language-plaintext highlighter-rouge">polarfire_syn_comps.v</code> file. They didn’t seem to have any real impact on my custom logic.</p> <p>The next step was to copy my newly created and tested HDL files back into my cloned cape. Note that the script that generated the project also creates extra HDL files that weren’t in the original <code class="language-plaintext highlighter-rouge">CUSTOM_CAPE/HDL</code> folder. When I run the <code class="language-plaintext highlighter-rouge">build-bitstream.py</code> script these should get re-generated so I don’t think they need to be copied. I did copy them over anyway to see what would happen and it didn’t seem to break anything. Checking the output <code class="language-plaintext highlighter-rouge">work</code> directory didn’t indicate any problems. These files include:</p> <ul> <li>miv_*.v</li> <li>apb_arbiter.v</li> <li>AXI4_address_shim.v</li> </ul> <p>Now I am ready to create my own <code class="language-plaintext highlighter-rouge">custom_cape.yaml</code> file from a copy of <code class="language-plaintext highlighter-rouge">gateware/custom-fpga-design/my_custom_fpga_design.yaml</code>. I update the <code class="language-plaintext highlighter-rouge">build-args</code> with the options that I want then take care to set <code class="language-plaintext highlighter-rouge">unique-design-version</code> to something new. There are a few things to note here:</p> <ul> <li>The FPGA bitstream loading application will skip the flashing process if the <code class="language-plaintext highlighter-rouge">Design Version</code> on the FPGA matches what is already stored on the FPGA. So this is something that will need to be updated every build.</li> <li>The <code class="language-plaintext highlighter-rouge">build-bitstream.py</code> script will look for “custom-fpga-design” in the path, and if the <code class="language-plaintext highlighter-rouge">*.yaml</code> file is stored there it will specify the design version based on a hash of the git repo. In practical terms, this means that if my <code class="language-plaintext highlighter-rouge">custom_cape.yaml</code> is located in a folder named “custom-fpga-design” the design name and version will be the same from build to build and the FPGA loading operation will be skipped. I can work around this if I place my configuration file in a different folder or by making a commit to the <code class="language-plaintext highlighter-rouge">gateware</code> repository between builds.</li> </ul> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gateware/custom_cape.yaml</span>
<span class="na">HSS</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
    <span class="na">link</span><span class="pi">:</span> <span class="s">https://git.beagleboard.org/beaglev-fire/hart-software-services.git</span>
    <span class="na">branch</span><span class="pi">:</span> <span class="s">develop-beaglev-fire</span>
    <span class="na">board</span><span class="pi">:</span> <span class="s">bvf</span>
<span class="na">gateware</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">sources</span>
    <span class="na">build-args</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TOP_LEVEL_NAME:</span><span class="se">\"</span><span class="s">my_custom_cape</span><span class="se">\"</span><span class="nv"> </span><span class="s">M2_OPTION:NONE</span><span class="nv"> </span><span class="s">CAPE_OPTION:CUSTOM_CAPE"</span>
    <span class="na">unique-design-version</span><span class="pi">:</span> <span class="s">0.0.1</span>
</code></pre></div></div> <p>With those changes in place I can kick off a build…</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">gateware$</span><span class="w"> </span>python3 build-bitstream.py ./custom_cape.yaml
</code></pre></div></div> <p>When the build completes, I check the <code class="language-plaintext highlighter-rouge">gateware/bitstream/LinuxProgramming</code> folder and see I have newly created bitfiles. Just like before I use SCP to copy the <code class="language-plaintext highlighter-rouge">LinuxProgramming</code> folder over to the home directory on the BeagleV and execute the <code class="language-plaintext highlighter-rouge">change-gateware.sh</code> script. The serial output from the BeagleV then shows I have the correct design name and version installed.</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">[2.09806] Design Info:
    Design Name: CUSTOM_CAPE_A5E630863F21B808BF
    Design Version: 00.00.2
</span></code></pre></div></div> <p>I then take a look at the board and see user LED 5 flashing on and off like I would expect! I took a scope to the output to check the timing and noticed that when the pin is in a “High” state it is actually super noisy around 1.5 volts. I surmise there is a problem with the logic that is causing the pin to turn on and off faster than my scope can measure. I will have to investigate further when I make part 2.</p> <h2 id="wrapping-up">Wrapping Up</h2> <h2 id="next-steps">Next Steps</h2> <ul> <li>The logic doesn’t appear to be working quite right so I need to investigate that and figure out what is going on.</li> <li>I would like to experiment with the peripherals such as I2C, SPI, and PWM.</li> <li>The workflow I have so far is functional but has room for improvement. I would like to have my FPGA design in a standalone project within it’s own repository so I am thinking I could do the following: <ul> <li>Start off with newly created <code class="language-plaintext highlighter-rouge">*.yaml</code> file with a new <code class="language-plaintext highlighter-rouge">key</code> for the high level details of a new project such as PATH and cape to copy.</li> <li>Create my own python script that clones the <code class="language-plaintext highlighter-rouge">VERILOG_TEMPLATE</code> cape and updates the tickle script automatically with the new name.</li> <li>Then further update that script so that it creates a standalone project from the same <code class="language-plaintext highlighter-rouge">*.yaml</code> file that I use for programming the device.</li> <li>I could then modify the existing python scripts to copy the HDL folder from a <code class="language-plaintext highlighter-rouge">type: external_source</code>.</li> </ul> </li> </ul> <h2 id="additional-resources">Additional Resources</h2> <ul> <li><a href="https://github.com/tio/tio" rel="external nofollow noopener" target="_blank">Tio</a></li> <li><a href="https://openbeagle.org/beaglev-fire" rel="external nofollow noopener" target="_blank">Top-Level BeagleV-Fire Repository</a></li> <li><a href="https://openbeagle.org/beaglev-fire/gateware" rel="external nofollow noopener" target="_blank">Gateware Repository</a></li> </ul> </article> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Aven Arlington. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with a heavily modified <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: February 06, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>