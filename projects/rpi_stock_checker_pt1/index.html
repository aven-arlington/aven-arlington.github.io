<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NSK99TZ0"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-01NSK99TZ0");</script> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Raspberry Pi Stock Checker | Aven Arlington</title> <meta name="author" content="Aven Arlington"> <meta name="description" content="Simple CLI to periodically check RSS feeds for Raspberry Pi 5 stock."> <meta name="keywords" content="Rust programming language, Rust tutorials, Rust graphics programming, Rust utilities, Rust projects, Rust examples, Rust game development tutorials, Rust embedded systems programming guide, Graphics programming using Rust language, Embedded development with Rust, IoT programming in Rust, Video game design in Rust, IoT projects with Rust programming, Circuit design, portfolio-website, tutorial, "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://aven-arlington.github.io/projects/rpi_stock_checker_pt1/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Aven </span>Arlington</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">GitHub Repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Resume</a> </li> <li class="nav-item "> <a class="nav-link" href="/cookoffs/">Cook-off</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Raspberry Pi Stock Checker</h1> <p class="post-description">Simple CLI to periodically check RSS feeds for Raspberry Pi 5 stock.</p></header> <article> <h2 id="background">Background</h2> <p>The Raspberry Pi 5 has begun shipping to distributors across the globe and I am excited to get my hands on one. Despite having signed up for a pre-order in October, I still hadn’t made it to the front of the back-order line. With Christmas fast approaching I needed to track down some stock and order one.</p> <p>I found myself checking the amazingly useful <a href="https://rpilocator.com/" rel="external nofollow noopener" target="_blank">rpilocator.com</a> once a day or so and thought “wouldn’t it be nice if I could automate this check and get a notification?”. I started looking into it and sure enough, the folks at <a href="[https://rpilocator.com/">rpilocator.com</a> offer a <a href="https://rpilocator.com/feed/" rel="external nofollow noopener" target="_blank">RSS feed</a>!</p> <p>The next step was to figure out how to download and parse a RSS feed. Luckily a quick google search turned up a the <a href="https://learn.microsoft.com/en-us/windows/dev-environment/rust/" rel="external nofollow noopener" target="_blank">Rust for Windows API</a> which includes a fully functional <a href="https://learn.microsoft.com/en-us/windows/dev-environment/rust/rss-reader-rust-for-windows" rel="external nofollow noopener" target="_blank">RSS reader</a> example.</p> <h2 id="prototyping">Prototyping</h2> <p>I created the rpi_stock_checker repository on GitHub and started configuring the Cargo.toml according to the example.</p> <div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[dependencies.windows]</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"*"</span>
<span class="py">features</span> <span class="p">=</span> <span class="p">[</span>
   <span class="s">"Foundation_Collections"</span><span class="p">,</span>
   <span class="s">"Web_Syndication"</span><span class="p">,</span>
   <span class="s">"UI_Notifications"</span><span class="p">,</span>
   <span class="s">"Data_Xml_Dom"</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div> <p>Next I update src/main.rs with the basic example code for testing I made sure to update the feed url to point to <a href="https://rpilocator.com/feed/" rel="external nofollow noopener" target="_blank">rpilocator.com/feed</a> as well.</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">windows</span><span class="p">::{</span>
    <span class="nn">core</span><span class="p">::</span><span class="o">*</span><span class="p">,</span>
    <span class="nn">Foundation</span><span class="p">::</span><span class="n">Uri</span><span class="p">,</span>
    <span class="nn">Web</span><span class="p">::</span><span class="nn">Syndication</span><span class="p">::</span><span class="n">SyndicationClient</span>
<span class="p">};</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nn">windows</span><span class="p">::</span><span class="nn">core</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">uri</span> <span class="o">=</span> <span class="nn">Uri</span><span class="p">::</span><span class="nf">CreateUri</span><span class="p">(</span><span class="nd">h!</span><span class="p">(</span><span class="s">"https://rpilocator.com/feed/"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">SyndicationClient</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="n">client</span><span class="nf">.SetRequestHeader</span><span class="p">(</span>
        <span class="nd">h!</span><span class="p">(</span><span class="s">"User-Agent"</span><span class="p">),</span>
        <span class="nd">h!</span><span class="p">(</span><span class="s">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0)"</span><span class="p">),</span>
    <span class="p">)</span><span class="o">?</span><span class="p">;</span>

    <span class="k">let</span> <span class="n">feed</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.RetrieveFeedAsync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uri</span><span class="p">)</span><span class="o">?</span><span class="nf">.get</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">feed</span><span class="nf">.Items</span><span class="p">()</span><span class="o">?</span> <span class="p">{</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">item</span><span class="nf">.Title</span><span class="p">()</span><span class="o">?</span><span class="nf">.Text</span><span class="p">()</span><span class="o">?</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div> <p>Executing the program results in the the output which in turn matches the live website. That means I now have feed data to work with.</p> <pre><code class="language-cmd">PS C:\rpi-stock-checker&gt; cargo run
   Compiling rpi-stock-checker v0.1.0 (C:\rpi-stock-checker)
    Finished dev [unoptimized + debuginfo] target(s) in 0.27s
     Running `target\debug\rpi-stock-checker.exe`
Stock Alert (PL): RPi 4 Model B - 8GB RAM is In Stock at Botland
Stock Alert (US): RPi CM4 - 4GB RAM, 8GB MMC, With Wifi is In Stock at Pishop 250 units in stock.
Stock Alert (US): RPi CM4 - 8GB RAM, 16GB MMC, With Wifi is In Stock at Pishop 250 units in stock.
Stock Alert (US): RPi CM4 - 8GB RAM, No MMC, No Wifi is In Stock at Pishop 250 units in stock.
</code></pre> <h2 id="parsing-the-feed">Parsing the Feed</h2> <p>Having the feed data is great, but the main goal is to have the program search the feed for the item I’m interested in.</p> <p>Lets start with some refactoring. When RetrieveFeedAsync is called there is a possibility that the call will fail if, for example, if the internet connection is interrupted. I want the program to be running in the background for long period of time and will need to handle the occasional connection hiccup gracefully. To facilitate handling these connection errors, a separate function is created for checking the feed.</p> <p>The check_feed function does all the heavy lifting to pull the RSS feed. It takes a reference to the SyndicationClient and then calls RetrieveFeedAsync with it. If the connection fails, a Err result is returned. If the connection is successful, I create a Vector of Strings to hold the feeds and return that to the caller.</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">check_feed</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">SyndicationClient</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">uri</span> <span class="o">=</span> <span class="nn">Uri</span><span class="p">::</span><span class="nf">CreateUri</span><span class="p">(</span><span class="nd">h!</span><span class="p">(</span><span class="s">"https://rpilocator.com/feed"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">feed</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.RetrieveFeedAsync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uri</span><span class="p">)</span><span class="o">?</span><span class="nf">.get</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">feed_items</span><span class="p">:</span> <span class="n">IVector</span><span class="o">&lt;</span><span class="n">SyndicationItem</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">feed</span><span class="nf">.Items</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">output_strings</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">feed_items</span> <span class="p">{</span>
        <span class="n">output_strings</span><span class="nf">.push</span><span class="p">(</span><span class="n">item</span><span class="nf">.Title</span><span class="p">()</span><span class="nf">.ok</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.Text</span><span class="p">()</span><span class="nf">.ok</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">output_strings</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>This approach allows me to branch execution based on a success or failure. If a failure is returned I simply print a courtesy string to stdout and then wait a few minutes to check again.</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">loop</span> <span class="p">{</span>
    <span class="k">match</span> <span class="nf">check_feed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">Ok</span><span class="p">(</span><span class="n">new_feeds</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="c1">// Do stuff //</span>
        <span class="p">}</span>
        <span class="nf">Err</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
            <span class="nd">println!</span><span class="p">(</span><span class="s">"Check_feed failed. Retrying in 5 minutes"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Update the stdout to show program is not idle/hung</span>
    <span class="nd">println!</span><span class="p">(</span><span class="s">"Sleeping for 5 minutes"</span><span class="p">);</span>
    <span class="c1">// Only check every 5 minutes to avoid spamming the RSS feed</span>
    <span class="nn">thread</span><span class="p">::</span><span class="nf">sleep</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">300</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now that feed data coming in every 5 minutes, I need to filter out the feed items that were detected in a previous read attempt, if a previous read was successful. Items that haven’t been seen before are printed to stdout with a timestamp so that a user can tell that the program is running.</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">Ok</span><span class="p">(</span><span class="n">new_feeds</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">feed</span> <span class="k">in</span> <span class="n">new_feeds</span> <span class="p">{</span>
        <span class="k">if</span> <span class="o">!</span><span class="n">prev_feeds</span><span class="nf">.contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">feed</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// New feed found</span>
            <span class="c1">// Do something with the new feed</span>
            <span class="n">prev_feeds</span><span class="nf">.insert</span><span class="p">(</span><span class="n">feed</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now I want to send a Windows Toast notification when a product that matches the search string is detected in a feed. Another standalone function is created to handle the notification process that takes the new feed item as input. The notify function then checks for the presence of the search string and it it matches, will initiate the Windows Toast Notification.</p> <p>The process of creating and sending a notification involves creating ToastNotification object and then showing it. Notifications are built from XML so an empty XmlDocument is created from a template. The newly created XmlDocument contains a single node that can be repurposed to display the notification text. GetElementsByTagName returns the IXmlNode tagged “text” that was included in the XmlDocument template. A new XmlText object is then created from the feed string and appended to the text node. Finally, the XmlDocument is passed to the CreateToastNotification function which creates the notification object.</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">notify</span><span class="p">(</span><span class="n">feed</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">String</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">feed</span><span class="nf">.contains</span><span class="p">(</span><span class="n">SEARCH_STRING</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// New feed detects search string. Send toast notification</span>
        <span class="k">let</span> <span class="n">notification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">toast_xml</span><span class="p">:</span> <span class="n">XmlDocument</span> <span class="o">=</span>
                <span class="nn">ToastNotificationManager</span><span class="p">::</span><span class="nf">GetTemplateContent</span><span class="p">(</span><span class="nn">ToastTemplateType</span><span class="p">::</span><span class="n">ToastText01</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">text_node</span><span class="p">:</span> <span class="n">IXmlNode</span> <span class="o">=</span> <span class="n">toast_xml</span><span class="nf">.GetElementsByTagName</span><span class="p">(</span><span class="nd">h!</span><span class="p">(</span><span class="s">"text"</span><span class="p">))</span><span class="o">?</span><span class="nf">.Item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">text</span><span class="p">:</span> <span class="n">XmlText</span> <span class="o">=</span> <span class="n">toast_xml</span><span class="nf">.CreateTextNode</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">HSTRING</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">feed</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
            <span class="n">text_node</span><span class="nf">.AppendChild</span><span class="p">(</span><span class="o">&amp;</span><span class="n">text</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="nn">ToastNotification</span><span class="p">::</span><span class="nf">CreateToastNotification</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toast_xml</span><span class="p">)</span><span class="o">?</span>
        <span class="p">};</span>
        <span class="c1">// Send the toast notification</span>
    <span class="p">}</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div> <p>With a ToastNotification object that contains the feed item text, the ToastNotificationManager can handle the details of showing it to the user. Note: showing the notification requires the AUMID from the application running the executable. In my case it is PowerShell 7.0. More on that below…</p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">ToastNotificationManager</span><span class="p">::</span><span class="nf">GetDefault</span><span class="p">()</span><span class="o">?</span>
            <span class="nf">.CreateToastNotifierWithId</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">HSTRING</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">AUMID</span><span class="p">))</span><span class="o">?</span>
            <span class="nf">.Show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notification</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div> <p>In order for the Windows Toast Notifications to work properly, the application must be built with the correct Application User Model ID (AUMID) for the terminal executing the application. The AUID may vary from machine to machine so this value must be set manually.</p> <p>To find the AUMID for PowerShell or Windows Terminal, run the following command in PowerShell:</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>Get-StartApps powershell
</code></pre></div></div> <p>And then copy the AppID value from the output into the AUMID constant in src/main.rs:line21</p> <p>For example: My machine produces the following output for Get-StartApps:</p> <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">PS C:\rpi-stock-checker&gt;</span><span class="w"> </span>Get-StartApps powershell
</code></pre></div></div> <h2 id="wrapping-up">Wrapping Up</h2> <p>With all these pieces in place, main.rs now looks something like the code below. The application gets the RSS feeds from the source, removes duplicates, and searches them for the product the user is interested in. The application is fault tolerant of network outages and will re-try failed connections. And finally, if the product of interest is found, a windows notification is sent to let the user know that it is in stock somewhere!</p> <h2 id="next-steps">Next Steps</h2> <p>There is still more to improve! To take the app even further, the next installment will break this code into manageable modules and add some unit testing.</p> <h2 id="code">Code</h2> <p><a href="https://github.com/aven-arlington/rpi-stock-checker/tree/v0.1" rel="external nofollow noopener" target="_blank">Source Code on GitHub</a></p> <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">chrono</span><span class="p">::</span><span class="nn">prelude</span><span class="p">::</span><span class="n">Local</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">collections</span><span class="p">::</span><span class="n">HashSet</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="n">thread</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">std</span><span class="p">::</span><span class="nn">time</span><span class="p">::</span><span class="n">Duration</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">windows</span><span class="p">::{</span>
    <span class="nn">core</span><span class="p">::</span><span class="o">*</span><span class="p">,</span>
    <span class="nn">Data</span><span class="p">::</span><span class="nn">Xml</span><span class="p">::</span><span class="nn">Dom</span><span class="p">::{</span><span class="n">IXmlNode</span><span class="p">,</span> <span class="n">XmlDocument</span><span class="p">,</span> <span class="n">XmlText</span><span class="p">},</span>
    <span class="nn">Foundation</span><span class="p">::{</span><span class="nn">Collections</span><span class="p">::</span><span class="n">IVector</span><span class="p">,</span> <span class="n">Uri</span><span class="p">},</span>
    <span class="nn">Web</span><span class="p">::</span><span class="nn">Syndication</span><span class="p">::{</span><span class="n">SyndicationClient</span><span class="p">,</span> <span class="n">SyndicationItem</span><span class="p">},</span>
    <span class="nn">UI</span><span class="p">::</span><span class="nn">Notifications</span><span class="p">::{</span><span class="n">ToastNotification</span><span class="p">,</span> <span class="n">ToastNotificationManager</span><span class="p">,</span> <span class="n">ToastTemplateType</span><span class="p">},</span>
<span class="p">};</span>

<span class="c1">// Modify this search string to math the product you are looking for</span>
<span class="k">static</span> <span class="n">SEARCH_STRING</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="o">=</span> <span class="s">"(US): RPi 5 - 8GB RAM"</span><span class="p">;</span>

<span class="c1">// Use the Microsoft AUMID for powershell, or terminal for notifications to</span>
<span class="c1">// function properly</span>
<span class="c1">// To find the AUMID of your powershell or terminal instance, run the following</span>
<span class="c1">// in powershell:</span>
<span class="c1">// Get-StartApps powershell</span>
<span class="k">static</span> <span class="n">AUMID</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span> <span class="o">=</span> <span class="s">"Microsoft.AutoGenerated.{A49227EA-5AF0-D494-A3F1-0918A278ED71}"</span><span class="p">;</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// Setup the RSS feed reader</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">prev_feeds</span><span class="p">:</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">HashSet</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">SyndicationClient</span><span class="p">::</span><span class="nf">new</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

    <span class="k">loop</span> <span class="p">{</span>
        <span class="c1">// Get available feeds</span>
        <span class="n">client</span><span class="nf">.SetRequestHeader</span><span class="p">(</span>
            <span class="nd">h!</span><span class="p">(</span><span class="s">"User-Agent"</span><span class="p">),</span>
            <span class="nd">h!</span><span class="p">(</span><span class="s">"Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0)"</span><span class="p">),</span>
        <span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="k">match</span> <span class="nf">check_feed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">new_feeds</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">for</span> <span class="n">feed</span> <span class="k">in</span> <span class="n">new_feeds</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="o">!</span><span class="n">prev_feeds</span><span class="nf">.contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">feed</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// New feed found</span>
                        <span class="k">let</span> <span class="n">now</span> <span class="o">=</span> <span class="nn">Local</span><span class="p">::</span><span class="nf">now</span><span class="p">();</span>
                        <span class="nd">println!</span><span class="p">(</span><span class="s">"{} - {}"</span><span class="p">,</span> <span class="n">now</span><span class="nf">.format</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">),</span> <span class="n">feed</span><span class="p">);</span>
                        <span class="nf">notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">feed</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Failed to send notification"</span><span class="p">);</span>
                        <span class="n">prev_feeds</span><span class="nf">.insert</span><span class="p">(</span><span class="n">feed</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="c1">// Allow time for async toast creation to complete</span>
                    <span class="nn">thread</span><span class="p">::</span><span class="nf">sleep</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_millis</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"Check_feed failed. Retrying in 5 minutes"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="c1">// Update the stdout to show program is not idle/hung</span>
        <span class="nd">println!</span><span class="p">(</span><span class="s">"Sleeping for 5 minutes"</span><span class="p">);</span>
        <span class="c1">// Only check every 5 minutes to avoid spamming the RSS feed</span>
        <span class="nn">thread</span><span class="p">::</span><span class="nf">sleep</span><span class="p">(</span><span class="nn">Duration</span><span class="p">::</span><span class="nf">from_secs</span><span class="p">(</span><span class="mi">300</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">check_feed</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">SyndicationClient</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">uri</span> <span class="o">=</span> <span class="nn">Uri</span><span class="p">::</span><span class="nf">CreateUri</span><span class="p">(</span><span class="nd">h!</span><span class="p">(</span><span class="s">"https://rpilocator.com/feed"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">feed</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.RetrieveFeedAsync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uri</span><span class="p">)</span><span class="o">?</span><span class="nf">.get</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="n">feed_items</span><span class="p">:</span> <span class="n">IVector</span><span class="o">&lt;</span><span class="n">SyndicationItem</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">feed</span><span class="nf">.Items</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">output_strings</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nn">Vec</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">feed_items</span> <span class="p">{</span>
        <span class="n">output_strings</span><span class="nf">.push</span><span class="p">(</span><span class="n">item</span><span class="nf">.Title</span><span class="p">()</span><span class="nf">.ok</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.Text</span><span class="p">()</span><span class="nf">.ok</span><span class="p">()</span><span class="nf">.unwrap</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="nf">Ok</span><span class="p">(</span><span class="n">output_strings</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">notify</span><span class="p">(</span><span class="n">feed</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">String</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">feed</span><span class="nf">.contains</span><span class="p">(</span><span class="n">SEARCH_STRING</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// New feed detects search string. Send toast notification</span>
        <span class="k">let</span> <span class="n">notification</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">toast_xml</span><span class="p">:</span> <span class="n">XmlDocument</span> <span class="o">=</span>
                <span class="nn">ToastNotificationManager</span><span class="p">::</span><span class="nf">GetTemplateContent</span><span class="p">(</span><span class="nn">ToastTemplateType</span><span class="p">::</span><span class="n">ToastText01</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">text_node</span><span class="p">:</span> <span class="n">IXmlNode</span> <span class="o">=</span> <span class="n">toast_xml</span><span class="nf">.GetElementsByTagName</span><span class="p">(</span><span class="nd">h!</span><span class="p">(</span><span class="s">"text"</span><span class="p">))</span><span class="o">?</span><span class="nf">.Item</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="k">let</span> <span class="n">text</span><span class="p">:</span> <span class="n">XmlText</span> <span class="o">=</span> <span class="n">toast_xml</span><span class="nf">.CreateTextNode</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">HSTRING</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">feed</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
            <span class="n">text_node</span><span class="nf">.AppendChild</span><span class="p">(</span><span class="o">&amp;</span><span class="n">text</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
            <span class="nn">ToastNotification</span><span class="p">::</span><span class="nf">CreateToastNotification</span><span class="p">(</span><span class="o">&amp;</span><span class="n">toast_xml</span><span class="p">)</span><span class="o">?</span>
        <span class="p">};</span>

        <span class="c1">// Send the toast notification</span>
        <span class="nn">ToastNotificationManager</span><span class="p">::</span><span class="nf">GetDefault</span><span class="p">()</span><span class="o">?</span>
            <span class="nf">.CreateToastNotifierWithId</span><span class="p">(</span><span class="o">&amp;</span><span class="nn">HSTRING</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">AUMID</span><span class="p">))</span><span class="o">?</span>
            <span class="nf">.Show</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notification</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div> </article><div id="giscus_thread" style="max-width: 1280px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"aven-arlington/aven-arlington.github.io","data-repo-id":"","data-category":"Comments","data-category-id":"","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Aven Arlington. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with a heavily modified <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: January 17, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>